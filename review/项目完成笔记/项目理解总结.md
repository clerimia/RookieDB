# RookieDB 数据库项目全面理解

## 项目概述
RookieDB 是加州大学伯克利分校 CS186 课程的教学数据库系统实现，是一个完整的单机关系型数据库管理系统。该项目采用 Java 8 实现，使用 Maven 构建系统，旨在帮助学生深入理解数据库内部原理。

## 核心架构

### 分层设计
项目采用经典的分层架构，从上到下包括：
- **应用层**: CLI 命令行界面和服务器接口
- **事务层**: Transaction 和 TransactionContext，提供 ACID 保证
- **数据库核心层**: Database 类，协调各个子系统
- **子系统层**: 六个核心子系统

### 六大子系统

#### 1. 存储管理层 (io 包)
- **DiskSpaceManager**: 管理磁盘空间分配，将分区映射到文件
- **PartitionHandle**: 管理分区的元数据
- 支持页面级别的存储管理

#### 2. 内存管理层 (memory 包)
- **BufferManager**: 缓冲区管理器，实现写回缓存
- **BufferFrame**: 单个缓冲区页面的封装
- **EvictionPolicy**: 支持 LRU 和 Clock 置换策略
- **Page**: 内存页面的抽象

#### 3. 并发控制层 (concurrency 包)
- **LockManager**: 实现严格的 2PL 锁机制
- **LockContext**: 支持多粒度锁层次结构
- **Lock**: 锁对象的抽象，支持 S/X/IS/IX/SIX 锁类型
- 实现死锁检测和预防

#### 4. 恢复管理层 (recovery 包)
- **ARIESRecoveryManager**: 实现 ARIES 恢复算法
- **LogManager**: 管理日志记录和刷盘
- 支持检查点、增量恢复和补偿日志记录

#### 5. 查询处理层 (query 包)
- **QueryPlan**: 查询计划生成和优化
- **QueryOperator**: 各种查询操作符的基类
- 支持的操作符：
  - SequentialScanOperator: 顺序扫描
  - IndexScanOperator: 索引扫描
  - SelectOperator: 选择过滤
  - ProjectOperator: 投影操作
  - JoinOperator: 连接操作（SNLJ, BNLJ）
  - SortOperator: 排序操作
  - GroupByOperator: 分组聚合
  - LimitOperator: 限制结果
- **查询优化**: 基于 System R 的动态规划算法
- **谓词下推**: 优化技术减少中间结果
- **外部排序**: 支持大数据集排序（Run 和 Partition）

#### 6. 表和索引层 (table 和 index 包)
- **Table**: 表的实现，使用页目录管理记录
- **Schema**: 表模式定义
- **Record**: 记录的抽象，包含多个 DataBox
- **BPlusTree**: B+ 树索引实现
- **BPlusNode**: B+ 树节点抽象
- **LeafNode/InnerNode**: 叶节点和内部节点实现

## 数据模型

### 类型系统
- **DataBox**: 数据值的抽象基类
- 支持的类型：IntDataBox, FloatDataBox, StringDataBox, BoolDataBox, LongDataBox, ByteArrayDataBox
- **Type**: 类型系统，支持类型检查和转换

### 记录管理
- **RecordId**: 记录标识符（页号 + 槽号）
- **PageDirectory**: 页目录实现堆文件结构
- 支持定长和变长字段

## 关键特性

### 事务支持
- ACID 特性完整实现
- 支持保存点 (Savepoint)
- 事务隔离级别控制
- 自动故障恢复

### 查询能力
- 完整的 SQL SELECT 语句支持
- 复杂连接查询
- 聚合函数 (COUNT, SUM, AVG)
- GROUP BY 分组
- ORDER BY 排序
- LIMIT 限制

### 索引优化
- B+ 树索引，支持范围查询
- 索引扫描优化
- 批量加载优化

### 并发控制
- 多粒度锁协议
- 严格两阶段锁定
- 死锁检测和预防

### 持久性保证
- ARIES 恢复算法
- Write-Ahead Logging
- 检查点机制
- 崩溃恢复

## 项目结构

### 开发环境
- Java 8/16 兼容
- Maven 构建系统
- JUnit 4 测试框架
- 支持 Docker 容器化部署

### 测试体系
- 分项目测试 (Proj0-5)
- 公开测试和隐藏测试
- 系统集成测试
- 性能压力测试

### 项目进度
- **Proj0**: 环境配置和基础实现
- **Proj2**: B+ 树索引实现
- **Proj3**: 查询优化器实现
- **Proj4**: 并发控制实现
- **Proj5**: 恢复机制实现

## 技术亮点

### 查询优化
- 基于 System R 的动态规划算法
- 成本基础的连接顺序选择
- 谓词下推优化
- 索引扫描选择

### 存储引擎
- 堆文件组织
- 页目录结构
- 定长记录存储
- 支持空值处理

### 缓冲管理
- 写回缓存策略
- LRU/Clock 置换算法
- 脏页跟踪
- 强制写入机制

### 并发机制
- 严格的 2PL 协议
- 意向锁机制
- 锁升级支持
- 死锁超时处理

### 恢复机制
- ARIES 三阶段恢复
- 日志顺序号管理
- 补偿日志记录
- 模糊检查点

## 实现细节

### 元数据管理
- 专门的元数据表 (_metadata.tables, _metadata.indices)
- 持久化模式信息
- 索引信息存储
- 版本控制支持

### 外部工具
- 命令行界面 (CLI)
- SQL 解析器 (JavaCC)
- 查询可视化
- 性能监控

### 内存优化
- 缓冲池管理
- 页面共享
- 迭代器模式
- 惰性求值

## 学习价值

这个项目涵盖了现代数据库系统的所有核心组件：
1. **存储引擎**: 文件组织、页面管理、缓冲机制
2. **索引结构**: B+ 树实现、范围查询、批量加载
3. **查询处理**: 操作符树、执行引擎、查询优化
4. **并发控制**: 锁机制、死锁处理、隔离级别
5. **恢复机制**: 日志记录、检查点、故障恢复

通过这个项目，学生能够深入理解数据库系统的内部工作原理，为后续学习和研究打下坚实基础。
