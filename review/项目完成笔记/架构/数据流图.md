# 数据流图

```mermaid
graph TD
    subgraph "数据流图"
        A[用户操作] --> B[CLI解析]
        B --> C[Transaction接口]
        C --> D[Database协调]
        
        D --> E[子系统调用]
        E --> F[存储管理]
        E --> G[并发控制]
        E --> H[恢复管理]
        
        C --> I[QueryPlan生成]
        I --> J[查询优化]
        J --> K[操作符树构建]
        K --> L[执行引擎]
        L --> M[数据访问]
        M --> N[BufferManager]
        N --> O[磁盘IO]
        
        M --> P[Table访问]
        M --> Q[BPlusTree访问]
        P --> N
        Q --> N
        
        G --> R[锁申请]
        H --> S[日志记录]
        
        D -.-> F
        D -.-> G
        D -.-> H
    end
    
    style A fill:#ffe4c4,stroke:#333
    style B fill:#d8bfd8,stroke:#333
    style C fill:#dda0dd,stroke:#333
    style D fill:#dda0dd,stroke:#333
    style E fill:#87ceeb,stroke:#333
    style F fill:#87ceeb,stroke:#333
    style G fill:#87ceeb,stroke:#333
    style H fill:#87ceeb,stroke:#333
    style I fill:#98fb98,stroke:#333
    style J fill:#98fb98,stroke:#333
    style K fill:#98fb98,stroke:#333
    style L fill:#98fb98,stroke:#333
    style M fill:#ffa07a,stroke:#333
    style N fill:#ffa07a,stroke:#333
    style O fill:#f0e68c,stroke:#333
    style P fill:#ffa07a,stroke:#333
    style Q fill:#ffa07a,stroke:#333
    style R fill:#87ceeb,stroke:#333
    style S fill:#87ceeb,stroke:#333
```

## 数据流向说明

### Database的协调作用
Database作为核心协调者，负责：
1. 管理和协调所有子系统(DiskSpaceManager、BufferManager、LockManager、RecoveryManager)
2. 处理DDL操作(创建/删除表和索引)
3. 管理事务的元数据信息

### 查询数据流
1. 用户通过CLI输入查询语句
2. CLI解析语句并调用Transaction接口
3. Transaction将请求传递给Database进行协调
4. 对于查询操作，Transaction创建QueryPlan进行查询规划
5. QueryPlan经过优化生成操作符树
6. 执行引擎按操作符树执行查询
7. 通过Table或BPlusTree访问数据
8. 数据访问通过BufferManager进行缓冲区管理
9. 必要时进行磁盘IO操作

### 更新数据流
1. 用户通过CLI输入更新语句
2. CLI解析语句并调用Transaction接口
3. Transaction将请求传递给Database进行协调
4. Database协调LockManager申请所需锁
5. Database协调RecoveryManager记录日志
6. 通过Table或BPlusTree更新数据
7. 更新通过BufferManager写入缓冲区
8. 后台刷新脏页到磁盘

### 事务控制流
- LockManager负责并发控制
- RecoveryManager负责故障恢复